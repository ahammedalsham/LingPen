{% extends 'base.html' %}
{% block title %}{{ blog.title if blog else 'New Blog' }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto my-8">

  <!-- Hero / Cover Image -->
  {% if blog and blog.cover_image %}
    <div class="rounded-xl overflow-hidden shadow mb-6">
      <img src="{{ url_for('static', filename=blog.cover_image) }}" alt="Blog Cover" class="w-full h-64 object-cover">
    </div>
  {% endif %}

  <div class="bg-white rounded-xl shadow p-6">

    <!-- Blog Header -->
    <div class="flex items-start justify-between gap-6">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-full overflow-hidden">
          <img src="{{ (blog.user.profile.photo_url if blog else current_user.profile.photo_url) or url_for('static', filename='default_avatar.png') }}" class="w-full h-full object-cover">
        </div>
        <div>
          <a href="{{ url_for('users.profile', user_id=blog.user.id) if blog else url_for('users.profile', user_id=current_user.id) }}" class="font-medium text-black">
            {{ (blog.user.profile.first_name if blog else current_user.profile.first_name) or (blog.user.email if blog else current_user.email) }}
          </a>
          {% if blog %}
            <div class="text-xs text-gray-500">{{ blog.created_at.strftime('%B %d, %Y • %H:%M') }}</div>
            {% if blog.reading_time %}
              <div class="text-xs text-gray-500">⏱ {{ blog.reading_time }} min read</div>
            {% endif %}
          {% endif %}
        </div>
      </div>

      {% if blog %}
      <div class="flex items-center gap-3">
        <div class="text-sm text-red-500">{{ blog.likes.count() }} ❤</div>
        {% if current_user.is_authenticated %}
          <form method="post" action="{{ url_for('blogs.like', blog_id=blog.id) }}">
            <button type="submit" class="px-3 py-1 border rounded text-sm text-red-600">
              {% if blog.likes.filter_by(user_id=current_user.id).first() %}
                Unlike ❤
              {% else %}
                Like ❤
              {% endif %}
            </button>
          </form>
        {% endif %}
        {% if current_user.is_authenticated and (current_user.id == blog.user_id or current_user.is_admin) %}
          <a href="{{ url_for('blogs.edit', blog_id=blog.id) }}" class="px-3 py-1 border rounded text-sm">Edit</a>
          <form method="post" action="{{ url_for('blogs.delete', blog_id=blog.id) }}" class="inline">
            <button type="submit" class="px-3 py-1 border rounded text-sm text-red-600">Delete</button>
          </form>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- Blog Content / Create Form -->
    {% if blog %}
      <h1 class="mt-4 text-3xl font-extrabold text-black">{{ blog.title }}</h1>
      <article class="mt-4 prose prose-indigo max-w-none text-gray-800">
        {{ blog.body|safe }}
      </article>
    {% else %}
      <h1 class="mt-4 text-3xl font-extrabold text-black">Create Your Blog</h1>
      <form method="POST" action="{{ url_for('blogs.create') }}" enctype="multipart/form-data" class="space-y-4 mt-4" id="blog-form">
        {{ form.hidden_tag() }}

        <div>
          {{ form.title.label(class="block text-sm font-medium text-gray-700") }}
          {{ form.title(class="mt-1 block w-full border rounded-lg p-3 shadow-sm focus:ring focus:ring-indigo-200") }}
        </div>

        <div>
          {{ form.tags.label(class_='block text-sm mb-1 font-medium') }}
          {{ form.tags(class_='w-full border rounded-lg p-3 shadow-sm focus:ring focus:ring-indigo-200') }}
        </div>
          
        <div>
          {{ form.category.label(class_='block text-sm mb-1 font-medium') }}
          {{ form.category(class_='w-full border rounded-lg p-3 shadow-sm focus:ring focus:ring-indigo-200') }}
        </div>

        <div>
          {{ form.cover_image.label(class="block text-sm font-medium text-gray-700") }}
          {{ form.cover_image(class="mt-1 block w-full text-sm text-gray-600") }}
        </div>

        <div>
          <label class="block text-sm mb-1 font-medium">Body</label>
          <div id="editor-container" class="border rounded-lg bg-white min-h-[300px]"></div>
          <input type="hidden" name="body" id="editor-field">
        </div>

        <div>
          <button type="submit" id="submit-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Publish</button>
        </div>
      </form>
    {% endif %}

    <!-- Share + Comments + Related Posts (only if blog exists) -->
    {% if blog %}
      <!-- Share Buttons -->
      <div class="mt-6 flex items-center gap-3">
        <span class="text-sm text-gray-500">Share:</span>
        <a href="https://twitter.com/intent/tweet?url={{ request.url }}" target="_blank" class="text-blue-500 hover:underline">Twitter</a>
        <a href="https://www.linkedin.com/shareArticle?url={{ request.url }}" target="_blank" class="text-blue-700 hover:underline">LinkedIn</a>
        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" target="_blank" class="text-blue-800 hover:underline">Facebook</a>
      </div>

      <hr class="my-6">

      <!-- Comments Section -->
      <div x-data="blogCommentsComponent({{ blog.id }})" x-init="loadComments()">
        <h2 class="font-semibold mb-3 text-lg">Discussion</h2>

        {% if current_user.is_authenticated %}
          <div class="mb-4">
            <textarea x-model="newComment" class="w-full border rounded p-3" placeholder="Share your thoughts..."></textarea>
            <div class="flex justify-between items-center mt-2">
              <div class="text-xs text-gray-500">Be respectful. Markdown is supported.</div>
              <div>
                <button @click="submitComment()" class="bg-blue-600 text-white px-4 py-2 rounded">Comment</button>
              </div>
            </div>
          </div>
        {% else %}
          <p class="text-sm text-gray-500">Please <a href="{{ url_for('auth.login') }}" class="text-blue-600 underline">login</a> to comment.</p>
        {% endif %}

        <div class="space-y-3">
          <template x-for="comment in comments" :key="comment.id">
            <div class="border rounded-lg p-3">
              <div class="flex justify-between items-start">
                <div>
                  <strong x-text="comment.user"></strong>
                  <div class="text-xs text-gray-400" x-text="comment.created_at"></div>
                </div>
              </div>
              <div class="mt-2" x-html="comment.body"></div>
            </div>
          </template>
        </div>
      </div>

      <!-- Related Posts -->
      {% if related_posts %}
        <div class="mt-10">
          <h3 class="font-semibold mb-4 text-lg">Related Posts</h3>
          <div class="grid md:grid-cols-3 gap-4">
            {% for post in related_posts %}
              <a href="{{ url_for('blogs.detail', blog_id=post.id) }}" class="block border rounded-lg overflow-hidden hover:shadow-lg transition">
                {% if post.cover_image %}
                  <img src="{{ url_for('static', filename=post.cover_image) }}" alt="{{ post.title }} Cover" class="w-full h-32 object-cover">
                {% endif %}
                <div class="p-3">
                  <h4 class="font-semibold text-black">{{ post.title }}</h4>
                  <p class="text-xs text-gray-500">{{ post.excerpt }}</p>
                </div>
              </a>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    {% endif %}
  </div>
</div>

<script src="https://unpkg.com/alpinejs" defer></script>
<script>
function blogCommentsComponent(blogId) {
  return {
    comments: [],
    newComment: "",
    async loadComments() {
      const res = await fetch(`/blogs/${blogId}/comments`);
      const data = await res.json();
      this.comments = data.map(c => ({ ...c, showReply: false, replyText: "" }));
    },
    async submitComment() {
      if (!this.newComment.trim()) return;
      const res = await fetch(`/blogs/${blogId}/comment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ body: this.newComment })
      });
      const data = await res.json();
      if (!data.error) {
        this.comments.unshift({ ...data, showReply: false, replyText: "" });
        this.newComment = "";
      }
    }
  }
}
</script>
<script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>
<script>
  const blogBody = {{ (blog.body if blog else "")|tojson|safe }};
  const DRAFT_KEY = "blog_draft_body_{{ blog.id if blog else 'new' }}";
  let editorInstance;

  ClassicEditor
    .create(document.querySelector('#editor-container'), {
      placeholder: 'Start writing your masterpiece here...',
      toolbar: {
        items: [
          'heading', '|',
          'bold', 'italic', 'underline', 'strikethrough', 'link', '|',
          'fontFamily', 'fontSize', 'fontColor', 'fontBackgroundColor', '|',
          'bulletedList', 'numberedList', 'outdent', 'indent', '|',
          'blockQuote', 'insertTable', 'imageUpload', 'mediaEmbed', 'codeBlock', 'horizontalLine', '|',
          'undo', 'redo', '|',
          'sourceEditing'
        ],
        shouldNotGroupWhenFull: true
      },
      heading: {
        options: [
          { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
          { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
          { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
          { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
        ]
      },
      image: {
        toolbar: [
          'imageStyle:inline',
          'imageStyle:block',
          'imageStyle:side',
          '|',
          'toggleImageCaption',
          'imageTextAlternative'
        ]
      },
      table: {
        contentToolbar: [
          'tableColumn',
          'tableRow',
          'mergeTableCells',
          'tableCellProperties',
          'tableProperties'
        ]
      }
    })
    .then(editor => {
      editorInstance = editor;
      const savedDraft = localStorage.getItem(DRAFT_KEY);
      editor.setData(savedDraft || blogBody);

      editor.model.document.on('change:data', () => {
        localStorage.setItem(DRAFT_KEY, editor.getData());
      });

      document.getElementById('blog-form').addEventListener('submit', (e) => {
        const html = editor.getData();
        if (!html || html.trim() === '') {
          e.preventDefault();
          alert('Please write something in the blog body before publishing.');
          return false;
        }
        document.getElementById('editor-field').value = html;
        localStorage.removeItem(DRAFT_KEY);
        document.getElementById('submit-btn').disabled = true;
      });
    })
    .catch(error => console.error(error));
</script>
{% endblock %}
