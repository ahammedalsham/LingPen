{% extends 'base.html' %}
{% block title %}{{ blog.title }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto my-8">
  <!-- Hero / Cover Image -->
  {% if blog.cover_image %}
    <div class="rounded-xl overflow-hidden shadow mb-6">
      <img src="{{ url_for('static', filename=blog.cover_image) }}" alt="{{ blog.title }} Cover" class="w-full h-64 object-cover">
    </div>
  {% endif %}

  <div class="bg-white rounded-xl shadow p-6">
    <!-- Blog Header -->
    <div class="flex items-start justify-between gap-6">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-full overflow-hidden">
          <img src="{{ blog.user.profile.photo_url or url_for('static', filename='default_avatar.png') }}" class="w-full h-full object-cover">
        </div>
        <div>
          <a href="{{ url_for('users.profile', user_id=blog.user.id) }}" class="font-medium text-black">
            {{ blog.user.profile.first_name or blog.user.email }}
          </a>
          <div class="text-xs text-gray-500">{{ blog.created_at.strftime('%B %d, %Y • %H:%M') }}</div>
          {% if blog.reading_time %}
            <div class="text-xs text-gray-500">⏱ {{ blog.reading_time }} min read</div>
          {% endif %}
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="text-sm text-red-500">{{ blog.likes.count() }} ❤</div>
        {% if current_user.is_authenticated %}
          <form method="post" action="{{ url_for('blogs.like', blog_id=blog.id) }}">
            <button type="submit" class="px-3 py-1 border rounded text-sm text-red-600">
              {% if blog.likes.filter_by(user_id=current_user.id).first() %}
                Unlike ❤
              {% else %}
                Like ❤
              {% endif %}
            </button>
          </form>
        {% endif %}
        {% if current_user.is_authenticated and (current_user.id == blog.user_id or current_user.is_admin) %}
          <a href="{{ url_for('blogs.edit', blog_id=blog.id) }}" class="px-3 py-1 border rounded text-sm">Edit</a>
          <form method="post" action="{{ url_for('blogs.delete', blog_id=blog.id) }}" class="inline">
            <button type="submit" class="px-3 py-1 border rounded text-sm text-red-600">Delete</button>
          </form>
        {% endif %}
      </div>
    </div>

    <!-- Blog Content -->
    <h1 class="mt-4 text-3xl font-extrabold text-black">{{ blog.title }}</h1>
    <article class="mt-4 prose prose-indigo max-w-none text-gray-800">
      {{ blog.body|safe }}
    </article>

    <!-- Share Buttons -->
    <div class="mt-6 flex items-center gap-3">
      <span class="text-sm text-gray-500">Share:</span>
      <a href="https://twitter.com/intent/tweet?url={{ request.url }}" target="_blank" class="text-blue-500 hover:underline">Twitter</a>
      <a href="https://www.linkedin.com/shareArticle?url={{ request.url }}" target="_blank" class="text-blue-700 hover:underline">LinkedIn</a>
      <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" target="_blank" class="text-blue-800 hover:underline">Facebook</a>
    </div>

    <hr class="my-6">

    <!-- Alpine.js threaded comments -->
    <div x-data="commentsComponent({{ blog.id }})" x-init="loadComments()">
      <h2 class="font-semibold mb-3">Comments</h2>

      <!-- New top-level comment -->
      {% if current_user.is_authenticated %}
        <div class="mb-4">
          <textarea x-model="newComment" class="w-full border rounded p-2" placeholder="Write a comment..."></textarea>
          <button @click="submitComment()" class="bg-blue-500 text-white px-3 py-1 rounded mt-2">Comment</button>
        </div>
      {% else %}
        <p class="text-sm text-gray-500">
          Please <a href="{{ url_for('auth.login') }}" class="text-blue-600 underline">login</a> to comment.
        </p>
      {% endif %}

      <!-- Comments List -->
      <div>
        <template x-for="comment in comments" :key="comment.id">
          <div class="border p-3 rounded mb-2">
            <p>
              <strong x-text="comment.user"></strong>
              <span x-text="comment.body"></span>
            </p>
            <p class="text-xs text-gray-500" x-text="comment.created_at"></p>

            <!-- Reply toggle -->
            {% if current_user.is_authenticated %}
            <div class="mt-2">
              <button @click="comment.showReply = !comment.showReply" class="text-xs text-blue-600">Reply</button>
              <div x-show="comment.showReply" class="mt-2">
                <textarea x-model="comment.replyText" class="w-full border rounded p-1 text-sm" placeholder="Reply..."></textarea>
                <button @click="submitReply(comment)" class="text-xs bg-gray-200 px-2 py-1 rounded mt-1">Blog Reply</button>
              </div>
            </div>
            {% endif %}

            <!-- Replies -->
            <div class="ml-6 mt-2 space-y-2">
              <template x-for="reply in comment.replies" :key="reply.id">
                <div class="border-l pl-3 text-sm">
                  <p>
                    <strong x-text="reply.user"></strong>
                    <span x-text="reply.body"></span>
                  </p>
                  <p class="text-xs text-gray-400" x-text="reply.created_at"></p>
                </div>
              </template>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Alpine.js component -->
  <script>
  function commentsComponent(blogId) {
    return {
      comments: [],
      newComment: "",
      async loadComments() {
        let res = await fetch(`/blogs/${blogId}/comments`);
        let data = await res.json();
        // Add reactive props for each comment
        this.comments = data.map(c => ({ ...c, showReply: false, replyText: "" }));
      },
      async submitComment() {
        if (!this.newComment.trim()) return;
        let res = await fetch(`/blogs/${blogId}/comment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ body: this.newComment })
        });
        let data = await res.json();
        if (!data.error) {
          this.comments.unshift({ ...data, showReply: false, replyText: "" });
          this.newComment = "";
        }
      },
      async submitReply(comment) {
        if (!comment.replyText || !comment.replyText.trim()) return;
        let res = await fetch(`/blogs/${blogId}/comment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ body: comment.replyText, parent_id: comment.id })
        });
        let data = await res.json();
        if (!data.error) {
          comment.replies.push({ ...data, showReply: false, replyText: "" });
          comment.replyText = "";
          comment.showReply = false;
        }
      }
    }
  }
  </script>
{% endblock %}
