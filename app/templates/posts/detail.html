{% extends 'base.html' %}
{% block title %}Post{% endblock %}

{% block content %}
<div class="border rounded-md p-4 bg-white">
  <!-- Post header -->
  <div class="flex justify-between items-start">
    <div>
      <div class="font-medium">
        <a href="{{ url_for('users.profile', user_id=post.user.id) }}">
          {{ post.user.profile.first_name or post.user.email }}
        </a>
      </div>
      <div class="text-xs text-gray-500">{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
    </div>
    <div class="text-sm">{{ post.likes.count() }} ‚ù§</div>
  </div>

  <!-- Post body -->
  <p class="mt-3">{{ post.body }}</p>

  <!-- Post actions -->
  <div class="mt-4 flex gap-2">
    {% if current_user.is_authenticated %}
      <form method="post" action="{{ url_for('posts.like', post_id=post.id) }}">
        <button class="px-3 py-1 border rounded">Like / Unlike</button>
      </form>
      {% if current_user.id == post.user_id or current_user.is_admin %}
        <a href="{{ url_for('posts.edit', post_id=post.id) }}" class="px-3 py-1 border rounded">Edit</a>
        <form method="post" action="{{ url_for('posts.delete', post_id=post.id) }}" class="inline">
          <button class="px-3 py-1 border rounded">Delete</button>
        </form>
      {% endif %}
    {% else %}
      <a href="{{ url_for('auth.login') }}" class="px-3 py-1 border rounded">Login to interact</a>
    {% endif %}
  </div>

  <hr class="my-4">

  <!-- Alpine.js threaded comments -->
  <div x-data="commentsComponent({{ post.id }})" x-init="loadComments()">
    <h2 class="font-semibold mb-3">Comments</h2>

    <!-- New top-level comment -->
    {% if current_user.is_authenticated %}
      <div class="mb-4">
        <textarea x-model="newComment" class="w-full border rounded p-2" placeholder="Write a comment..."></textarea>
        <button @click="submitComment()" class="bg-blue-500 text-white px-3 py-1 rounded mt-2">Comment</button>
      </div>
    {% else %}
      <p class="text-sm text-gray-500">
        Please <a href="{{ url_for('auth.login') }}" class="text-blue-600 underline">login</a> to comment.
      </p>
    {% endif %}

    <!-- Comments List -->
    <div>
      <template x-for="comment in comments" :key="comment.id">
        <div class="border p-3 rounded mb-2">
          <p>
            <strong x-text="comment.user"></strong>
            <span x-text="comment.body"></span>
          </p>
          <p class="text-xs text-gray-500" x-text="comment.created_at"></p>

          <!-- Reply toggle -->
          {% if current_user.is_authenticated %}
          <div class="mt-2">
            <button @click="comment.showReply = !comment.showReply" class="text-xs text-blue-600">Reply</button>
            <div x-show="comment.showReply" class="mt-2">
              <textarea x-model="comment.replyText" class="w-full border rounded p-1 text-sm" placeholder="Reply..."></textarea>
              <button @click="submitReply(comment)" class="text-xs bg-gray-200 px-2 py-1 rounded mt-1">Post Reply</button>
            </div>
          </div>
          {% endif %}

          <!-- Replies -->
          <div class="ml-6 mt-2 space-y-2">
            <template x-for="reply in comment.replies" :key="reply.id">
              <div class="border-l pl-3 text-sm">
                <p>
                  <strong x-text="reply.user"></strong>
                  <span x-text="reply.body"></span>
                </p>
                <p class="text-xs text-gray-400" x-text="reply.created_at"></p>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>
</div>

<!-- Alpine.js component -->
<script>
function commentsComponent(postId) {
  return {
    comments: [],
    newComment: "",
    async loadComments() {
      let res = await fetch(`/posts/${postId}/comments`);
      let data = await res.json();
      // Add reactive props for each comment
      this.comments = data.map(c => ({ ...c, showReply: false, replyText: "" }));
    },
    async submitComment() {
      if (!this.newComment.trim()) return;
      let res = await fetch(`/posts/${postId}/comment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ body: this.newComment })
      });
      let data = await res.json();
      if (!data.error) {
        this.comments.unshift({ ...data, showReply: false, replyText: "" });
        this.newComment = "";
      }
    },
    async submitReply(comment) {
      if (!comment.replyText || !comment.replyText.trim()) return;
      let res = await fetch(`/posts/${postId}/comment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ body: comment.replyText, parent_id: comment.id })
      });
      let data = await res.json();
      if (!data.error) {
        comment.replies.push({ ...data, showReply: false, replyText: "" });
        comment.replyText = "";
        comment.showReply = false;
      }
    }
  }
}
</script>
{% endblock %}